<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Banco de Mídia - Igreja (HTML + Firebase)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:#f5f7fb;color:#111}
    header{background:#fff;padding:12px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #e6e9ef}
    .container{max-width:1100px;margin:18px auto;padding:0 16px}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:10px;border:1px solid #d1d7e0;background:#fff;cursor:pointer}
    .search{flex:1;padding:8px 12px;border-radius:8px;border:1px solid #d1d7e0;background:#fff}
    .toolbar{display:flex;gap:8px;align-items:center;margin:12px 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .card{background:#fff;border-radius:10px;overflow:hidden;border:1px solid #e6e9ef}
    .thumb{height:140px;display:block;width:100%;object-fit:cover;background:#eee}
    .meta{padding:8px;font-size:13px;display:flex;justify-content:space-between;align-items:center}
    .tags{color:#6b7280;font-size:12px}
    footer{padding:12px;text-align:center;color:#6b7280;font-size:13px}
    .note{background:#fffbe6;border:1px solid #ffe7a3;padding:10px;border-radius:8px;margin-bottom:12px;color:#7a5a00}
    .hidden{display:none}
  </style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:12px">
    <h2 style="margin:0;font-size:18px">Banco de Mídia da Igreja</h2>
    <small style="color:#6b7280">Fotos e vídeos para cultos e eventos</small>
  </div>
  <div id="auth-area">
    <button id="btn-login" class="btn">Entrar com Google</button>
  </div>
</header>

<main class="container">
  <div class="toolbar">
    <input id="search" class="search" placeholder="Buscar por nome, tags, categoria, autor..." />
    <select id="filter-kind" class="btn" style="padding:8px 10px">
      <option value="all">Tudo</option>
      <option value="image">Imagens</option>
      <option value="video">Vídeos</option>
    </select>

    <select id="category" class="btn">
      <option value="geral">Geral</option>
      <option value="louvor">Louvor</option>
      <option value="eventos">Eventos</option>
      <option value="jovens">Jovens</option>
      <option value="infantil">Infantil</option>
    </select>

    <input id="tags" placeholder="tags (virgula)" style="padding:8px;border-radius:10px;border:1px solid #d1d7e0" />

    <!-- upload só aparece para admins -->
    <input id="file-input" type="file" accept="image/*,video/*" multiple class="hidden" />
    <button id="btn-upload" class="btn hidden">Enviar arquivos</button>
  </div>

  <div id="notice" class="note hidden"></div>

  <section id="gallery" class="grid"></section>

  <div id="progress-list" style="margin-top:14px"></div>
</main>

<footer>
  © <span id="year"></span> Banco de Mídia da Igreja — feito com Firebase
</footer>

<script type="module">
  // ====== CONFIGURE AQUI ======
  const firebaseConfig = {
  apiKey: "AIzaSyBWTd3IUwU-1ZvuYLRZTPRzPvAkFrY9afw",
  authDomain: "fotos-78dad.firebaseapp.com",
  projectId: "fotos-78dad",
  storageBucket: "fotos-78dad.firebasestorage.app",
  messagingSenderId: "977001841403",
  appId: "1:977001841403:web:e1c8469ced4097082c665e"
};

  // e-mails dos administradores (em minúsculo). Só eles podem enviar/remover.
  const ADMIN_EMAILS = [
    // "lider@igreja.com",
    // "midia@igreja.com"
  ];

  // ============================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, where, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

  // init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // ui refs
  const authArea = document.getElementById('auth-area');
  const btnLogin = document.getElementById('btn-login');
  const fileInput = document.getElementById('file-input');
  const btnUpload = document.getElementById('btn-upload');
  const gallery = document.getElementById('gallery');
  const notice = document.getElementById('notice');
  const searchInput = document.getElementById('search');
  const filterKind = document.getElementById('filter-kind');
  const categorySel = document.getElementById('category');
  const tagsInput = document.getElementById('tags');
  const progressList = document.getElementById('progress-list');
  document.getElementById('year').innerText = new Date().getFullYear();

  let currentUser = null;
  let liveUnsub = null;

  // helpers
  const isAdmin = (email) => email && ADMIN_EMAILS.includes(email.toLowerCase());

  function renderAuth(user) {
    authArea.innerHTML = '';
    if (!user) {
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.innerText = 'Entrar com Google';
      btn.onclick = login;
      authArea.appendChild(btn);
      notice.classList.add('hidden');
      btnUpload.classList.add('hidden');
    } else {
      const span = document.createElement('span');
      span.style.marginRight = '8px';
      span.style.color = '#374151';
      span.innerText = user.displayName || user.email;
      authArea.appendChild(span);

      const btnOut = document.createElement('button');
      btnOut.className = 'btn';
      btnOut.innerText = 'Sair';
      btnOut.onclick = logout;
      authArea.appendChild(btnOut);

      if (isAdmin(user.email)) {
        btnUpload.classList.remove('hidden');
        notice.classList.add('hidden');
      } else {
        btnUpload.classList.add('hidden');
        notice.innerHTML = '<b>Upload restrito:</b> apenas administradores podem enviar arquivos. Você pode baixar normalmente.';
        notice.classList.remove('hidden');
      }
    }
  }

  // auth
  async function login() {
    const provider = new GoogleAuthProvider();
    try {
      await signInWithPopup(auth, provider);
    } catch (err) {
      alert('Erro ao logar: ' + err.message);
    }
  }
  async function logout() { await signOut(auth); }

  onAuthStateChanged(auth, user => {
    currentUser = user;
    renderAuth(user);
  });

  // live list
  function startLiveQuery() {
    if (liveUnsub) liveUnsub();
    // construir query com filtro simples
    const base = collection(db, 'media');
    const q = query(base, orderBy('createdAt', 'desc'));
    liveUnsub = onSnapshot(q, snap => {
      const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      displayGallery(docs);
    });
  }

  startLiveQuery();

  // display
  function displayGallery(items) {
    const qText = searchInput.value.trim().toLowerCase();
    const kind = filterKind.value;
    const filtered = items.filter(it => {
      if (kind !== 'all' && it.kind !== kind) return false;
      if (!qText) return true;
      const hay = [
        it.filename, it.category, ...(it.tags||[]), it.uploaderName || '', it.uploaderEmail || ''
      ].filter(Boolean).join(' ').toLowerCase();
      return hay.includes(qText);
    });

    gallery.innerHTML = '';
    if (filtered.length === 0) {
      gallery.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#6b7280;padding:40px;background:#fff;border-radius:10px;border:1px solid #e6e9ef">Nenhum item encontrado.</div>';
      return;
    }

    filtered.forEach(it => {
      const card = document.createElement('div'); card.className = 'card';
      // thumb
      if (it.kind === 'image') {
        const img = document.createElement('img');
        img.src = it.url;
        img.alt = it.filename;
        img.className = 'thumb';
        card.appendChild(img);
      } else if (it.kind === 'video') {
        const vid = document.createElement('video');
        vid.src = it.url;
        vid.className = 'thumb';
        vid.controls = true;
        card.appendChild(vid);
      } else {
        const box = document.createElement('div');
        box.className = 'thumb';
        box.innerText = 'Arquivo';
        box.style.display = 'flex';
        box.style.alignItems = 'center';
        box.style.justifyContent = 'center';
        card.appendChild(box);
      }

      // meta
      const meta = document.createElement('div'); meta.className = 'meta';
      const left = document.createElement('div');
      left.innerHTML = '<div style="font-weight:600;font-size:14px;max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + it.filename + '</div>'
        + '<div class="tags">' + (it.category || 'geral') + ' ' + ((it.tags||[]).slice(0,3).map(t=>' #'+t).join('')) + '</div>';
      meta.appendChild(left);

      const actions = document.createElement('div');
      // download
      const a = document.createElement('a'); a.href = it.url; a.download = it.filename;
      a.className = 'btn'; a.style.fontSize = '13px'; a.innerText = 'Baixar';
      actions.appendChild(a);

      // delete (se admin ou uploader)
      const canDelete = currentUser && ( isAdmin((currentUser.email||'').toLowerCase()) || it.uploaderUid === (currentUser.uid||'') );
      if (canDelete) {
        const del = document.createElement('button'); del.className = 'btn'; del.innerText = 'Excluir';
        del.onclick = async () => {
          if (!confirm('Remover "'+it.filename+'"?')) return;
          try {
            // delete from storage
            const storageRef = ref(storage, it.storagePath);
            await deleteObject(storageRef).catch(()=>{});
            // delete doc
            await deleteDoc(doc(db, 'media', it.id));
            alert('Removido.');
          } catch (err) {
            alert('Erro ao remover: ' + err.message);
          }
        };
        actions.appendChild(del);
      }

      meta.appendChild(actions);
      card.appendChild(meta);
      gallery.appendChild(card);
    });
  }

  // upload (apenas admin)
  btnUpload.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files || []);
    if (!currentUser) { alert('Faça login.'); return; }
    if (!isAdmin(currentUser.email)) { alert('Você não tem permissão para enviar.'); return; }
    if (files.length === 0) return;

    for (const file of files) {
      const path = `uploads/${currentUser.uid}/${Date.now()}_${file.name}`;
      const storageRef = ref(storage, path);
      const uploadTask = uploadBytesResumable(storageRef, file);

      // show progress UI
      const pRow = document.createElement('div');
      pRow.style.background = '#fff'; pRow.style.border = '1px solid #e6e9ef'; pRow.style.padding = '8px'; pRow.style.borderRadius = '8px';
      pRow.innerText = 'Enviando ' + file.name + ' — 0%';
      progressList.appendChild(pRow);

      uploadTask.on('state_changed',
        snapshot => {
          const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
          pRow.innerText = 'Enviando ' + file.name + ' — ' + pct + '%';
        },
        error => {
          pRow.innerText = 'Erro ao enviar ' + file.name + ': ' + error.message;
        },
        async () => {
          try {
            const url = await getDownloadURL(uploadTask.snapshot.ref);
            // meta
            const kind = file.type.startsWith('image/') ? 'image' : file.type.startsWith('video/') ? 'video' : 'other';
            await addDoc(collection(db, 'media'), {
              url, storagePath: path, filename: file.name, size: file.size, type: file.type,
              kind, category: categorySel.value || 'geral',
              tags: (tagsInput.value || '').split(',').map(t=>t.trim().toLowerCase()).filter(Boolean),
              uploaderUid: currentUser.uid, uploaderName: currentUser.displayName || currentUser.email,
              uploaderEmail: (currentUser.email||'').toLowerCase(),
              createdAt: serverTimestamp()
            });
            pRow.innerText = 'Enviado: ' + file.name;
            setTimeout(()=>pRow.remove(), 2500);
          } catch (err) {
            pRow.innerText = 'Erro ao salvar meta: ' + err.message;
          }
        }
      );
    }

    e.target.value = '';
  });

  // filtros reativos
  searchInput.addEventListener('input', startLiveQuery);
  filterKind.addEventListener('change', startLiveQuery);

  // Inicial: start live query já rodou acima.

  // ===== Regras sugeridas do Firebase (cole nas regras do console) =====
  // Firestore (exemplo):
  /*
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      function isAdmin() {
        return request.auth != null && ['lider@igreja.com','midia@igreja.com'].contains(request.auth.token.email);
      }
      match /media/{docId} {
        allow read: if true;
        allow create: if isAdmin();
        allow delete, update: if isAdmin() || (request.auth != null && resource.data.uploaderUid == request.auth.uid);
      }
    }
  }
  */
  // Storage (exemplo):
  /*
  rules_version = '2';
  service firebase.storage {
    match /b/{bucket}/o {
      function isAdmin() {
        return request.auth != null && ['lider@igreja.com','midia@igreja.com'].contains(request.auth.token.email);
      }
      match /uploads/{uid}/{allPaths=**} {
        allow read: if true;
        allow write: if isAdmin();
      }
    }
  }
  */
  // =====================================================================
</script>

</body>
</html>
